<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProfileServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TeamPlanner-BE</a> &gt; <a href="index.source.html" class="el_package">com.tbfp.teamplannerbe.domain.profile.service.impl</a> &gt; <span class="el_source">ProfileServiceImpl.java</span></div><h1>ProfileServiceImpl.java</h1><pre class="source lang-java linenums">package com.tbfp.teamplannerbe.domain.profile.service.impl;

import com.tbfp.teamplannerbe.domain.common.exception.ApplicationErrorType;
import com.tbfp.teamplannerbe.domain.common.exception.ApplicationException;
import com.tbfp.teamplannerbe.domain.profile.CRUDType;
import com.tbfp.teamplannerbe.domain.profile.dto.ProfileRequestDto;
import com.tbfp.teamplannerbe.domain.profile.dto.ProfileResponseDto;
import com.tbfp.teamplannerbe.domain.member.entity.Member;
import com.tbfp.teamplannerbe.domain.member.repository.*;
import com.tbfp.teamplannerbe.domain.profile.entity.*;
import com.tbfp.teamplannerbe.domain.profile.repository.*;
import com.tbfp.teamplannerbe.domain.profile.service.ProfileService;
import com.tbfp.teamplannerbe.domain.team.dto.TeamRequestDto;
import com.tbfp.teamplannerbe.domain.team.dto.TeamResponseDto;
import com.tbfp.teamplannerbe.domain.team.entity.MemberTeam;
import com.tbfp.teamplannerbe.domain.team.entity.Team;
import com.tbfp.teamplannerbe.domain.team.repository.MemberTeamRepository;
import com.tbfp.teamplannerbe.domain.team.repository.TeamRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import java.util.stream.Collectors;

import static com.tbfp.teamplannerbe.domain.common.exception.ApplicationErrorType.*;


@Service
<span class="nc" id="L31">@RequiredArgsConstructor</span>
<span class="nc" id="L32">@Slf4j</span>
public class ProfileServiceImpl implements ProfileService {

    private final MemberRepository memberRepository;
    private final TechStackRepository techStackRepository;
    private final TechStackItemRepository techStackItemRepository;
    private final ActivityRepository activityRepository;
    private final CertificationRepository certificationRepository;
    private final EvaluationRepository evaluationRepository;
    private final BasicProfileRepository basicProfileRepository;
    private final TeamRepository teamRepository;
    private final MemberTeamRepository memberTeamRepository;

    @Override
    @Transactional
    public ProfileResponseDto.ShowProfileResponseDto showProfile(String nickname){

<span class="nc" id="L49">        Optional&lt;Member&gt; member = memberRepository.findByNickname(nickname);</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if(!member.isPresent()) throw new ApplicationException(ApplicationErrorType.USER_NOT_FOUND);</span>

<span class="nc" id="L52">        Long memberId = member.get().getId();</span>

<span class="nc" id="L54">        ProfileResponseDto.BasicProfileResponseDto basicProfileResponseDto = basicProfileRepository.findByMemberId(memberId).orElseThrow(()-&gt;new ApplicationException(ApplicationErrorType.PROFILE_NOT_EXIST)).toDto();</span>
<span class="nc" id="L55">        List&lt;ProfileResponseDto.TechStackResponseDto&gt; techStackResponseDtos = techStackRepository.findAllByMemberId(memberId).orElse(null).stream().map(TechStack::toDto).collect(Collectors.toList());</span>
<span class="nc" id="L56">        List&lt;ProfileResponseDto.ActivityResponseDto&gt; activityResponseDtos = activityRepository.findAllByMemberId(memberId).orElse(null).stream().map(Activity::toDto).collect(Collectors.toList());</span>
<span class="nc" id="L57">        List&lt;ProfileResponseDto.CertificationResponseDto&gt; certificationResponseDtos = certificationRepository.findAllByMemberId(memberId).orElse(null).stream().map(Certification::toDto).collect(Collectors.toList());</span>
<span class="nc" id="L58">        List&lt;ProfileResponseDto.EvaluationResponseDto&gt; evaluationResponseDtos = evaluationRepository.findAllBySubjectMemberId(memberId).orElse(null).stream().map(Evaluation::toDto).collect(Collectors.toList());</span>

<span class="nc" id="L60">        return ProfileResponseDto.ShowProfileResponseDto.builder()</span>
<span class="nc" id="L61">                .basicProfile(basicProfileResponseDto)</span>
<span class="nc" id="L62">                .techStacks(techStackResponseDtos)</span>
<span class="nc" id="L63">                .activities(activityResponseDtos)</span>
<span class="nc" id="L64">                .certifications(certificationResponseDtos)</span>
<span class="nc" id="L65">                .evaluations(evaluationResponseDtos)</span>
<span class="nc" id="L66">                .build();</span>
    }

    @Override
    @Transactional
    public ProfileResponseDto.GetProfileResponseDto getProfile(String username){

<span class="nc" id="L73">        Optional&lt;Member&gt; member = memberRepository.findMemberByUsername(username);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if(!member.isPresent()) throw new ApplicationException(ApplicationErrorType.USER_NOT_FOUND);</span>

<span class="nc" id="L76">        Long memberId = member.get().getId();</span>

<span class="nc" id="L78">        ProfileResponseDto.BasicProfileResponseDto basicProfileResponseDto = basicProfileRepository.findByMemberId(memberId).orElseThrow(()-&gt;new ApplicationException(ApplicationErrorType.PROFILE_NOT_EXIST)).toDto();</span>
<span class="nc" id="L79">        List&lt;ProfileResponseDto.TechStackResponseDto&gt; techStackResponseDtos = techStackRepository.findAllByMemberId(memberId).orElse(null).stream().map(TechStack::toDto).collect(Collectors.toList());</span>
<span class="nc" id="L80">        List&lt;ProfileResponseDto.ActivityResponseDto&gt; activityResponseDtos = activityRepository.findAllByMemberId(memberId).orElse(null).stream().map(Activity::toDto).collect(Collectors.toList());</span>
<span class="nc" id="L81">        List&lt;ProfileResponseDto.CertificationResponseDto&gt; certificationResponseDtos = certificationRepository.findAllByMemberId(memberId).orElse(null).stream().map(Certification::toDto).collect(Collectors.toList());</span>
<span class="nc" id="L82">        List&lt;ProfileResponseDto.EvaluationResponseDto&gt; evaluationResponseDtos = evaluationRepository.findAllBySubjectMemberId(memberId).orElse(null).stream().map(Evaluation::toDto).collect(Collectors.toList());</span>
<span class="nc" id="L83">        return ProfileResponseDto.GetProfileResponseDto.builder()</span>
<span class="nc" id="L84">                .basicProfile(basicProfileResponseDto)</span>
<span class="nc" id="L85">                .techStacks(techStackResponseDtos)</span>
<span class="nc" id="L86">                .activities(activityResponseDtos)</span>
<span class="nc" id="L87">                .certifications(certificationResponseDtos)</span>
<span class="nc" id="L88">                .evaluations(evaluationResponseDtos)</span>
<span class="nc" id="L89">                .build();</span>
    }

    @Override
    @Transactional
    public ProfileResponseDto.CreateProfileResponseDto createProfile(ProfileRequestDto.CreateProfileRequestDto createProfileRequestDto, String username){
<span class="nc" id="L95">        Member member = memberRepository.findMemberByUsername(username).orElseThrow(() -&gt; new ApplicationException(ApplicationErrorType.USER_NOT_FOUND));</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">        if(basicProfileRepository.findByMemberId(member.getId()).isPresent()){</span>
<span class="nc" id="L98">            throw new ApplicationException(ApplicationErrorType.PROFILE_ALREADY_EXIST);</span>
        }

<span class="nc" id="L101">        ProfileRequestDto.BasicProfileRequestDto basicProfileRequestDto = createProfileRequestDto.getBasicProfile();</span>
<span class="nc" id="L102">        List&lt;ProfileRequestDto.TechStackRequestDto&gt; techStackRequestDtos = createProfileRequestDto.getTechStacks();</span>
<span class="nc" id="L103">        storeUserGeneratedTechStackItem(techStackRequestDtos, member.getId());</span>

<span class="nc" id="L105">        List&lt;ProfileRequestDto.ActivityRequestDto&gt; activityRequestDtos = createProfileRequestDto.getActivities();</span>
<span class="nc" id="L106">        List&lt;ProfileRequestDto.CertificationRequestDto&gt; certificationRequestDtos = createProfileRequestDto.getCertifications();</span>

<span class="nc" id="L108">        basicProfileRepository.save(basicProfileRequestDto.toEntity(member));</span>
<span class="nc" id="L109">        techStackRepository.saveAll(techStackRequestDtos.stream().map(TechStackDto -&gt; TechStackDto.toEntity(member)).collect(Collectors.toList()));</span>
<span class="nc" id="L110">        activityRepository.saveAll(activityRequestDtos.stream().map(ActivityDto -&gt; ActivityDto.toEntity(member)).collect(Collectors.toList()));</span>
<span class="nc" id="L111">        certificationRepository.saveAll(certificationRequestDtos.stream().map(CertificationDto -&gt; CertificationDto.toEntity(member)).collect(Collectors.toList()));</span>

<span class="nc" id="L113">        return ProfileResponseDto.CreateProfileResponseDto.builder()</span>
<span class="nc" id="L114">                .message(&quot;프로필 생성에 성공했습니다.&quot;)</span>
<span class="nc" id="L115">                .build();</span>
    }

    @Override
    @Transactional
    public ProfileResponseDto.UpdateProfileResponseDto updateProfile(ProfileRequestDto.UpdateProfileRequestDto updateProfileRequestDto, String username){
<span class="nc" id="L121">        Member member = memberRepository.findMemberByUsername(username).orElseThrow(() -&gt; new ApplicationException(ApplicationErrorType.USER_NOT_FOUND));</span>

<span class="nc" id="L123">        ProfileRequestDto.BasicProfileRequestDto basicProfileRequestDto = updateProfileRequestDto.getBasicProfile();</span>
<span class="nc" id="L124">        List&lt;ProfileRequestDto.TechStackRequestDto&gt; techStackRequestDtos = updateProfileRequestDto.getTechStacks();</span>
<span class="nc" id="L125">        storeUserGeneratedTechStackItem(techStackRequestDtos, member.getId());</span>

<span class="nc" id="L127">        List&lt;ProfileRequestDto.ActivityRequestDto&gt; activityRequestDtos = updateProfileRequestDto.getActivities();</span>
<span class="nc" id="L128">        List&lt;ProfileRequestDto.CertificationRequestDto&gt; certificationRequestDtos = updateProfileRequestDto.getCertifications();</span>

        //BasicProfile
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if(basicProfileRequestDto.getCrudType()==CRUDType.DELETE){</span>
<span class="nc" id="L132">            basicProfileRepository.deleteByMember(member);</span>
        } else{
<span class="nc" id="L134">            basicProfileRepository.save(basicProfileRequestDto.toEntity(member));</span>
        }

        // TechStacks
<span class="nc" id="L138">        List&lt;ProfileRequestDto.TechStackRequestDto&gt; deleteTechStacks = techStackRequestDtos.stream()</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                .filter(dto -&gt; dto.getCrudType() == CRUDType.DELETE)</span>
<span class="nc" id="L140">                .collect(Collectors.toList());</span>

<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!deleteTechStacks.isEmpty()) {</span>
<span class="nc" id="L143">            List&lt;Long&gt; techStackIdsToDelete = deleteTechStacks.stream()</span>
<span class="nc" id="L144">                    .map(ProfileRequestDto.TechStackRequestDto::getId)</span>
<span class="nc" id="L145">                    .collect(Collectors.toList());</span>

<span class="nc" id="L147">            techStackRepository.deleteAllByIdInAndMember(techStackIdsToDelete, member);</span>
        }

<span class="nc" id="L150">        List&lt;TechStack&gt; techStacks = techStackRequestDtos.stream()</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                .filter(dto -&gt; dto.getCrudType() != CRUDType.DELETE)</span>
<span class="nc" id="L152">                .map(dto -&gt; dto.toEntity(member))</span>
<span class="nc" id="L153">                .collect(Collectors.toList());</span>
<span class="nc" id="L154">        techStackRepository.saveAll(techStacks);</span>

        // Activities
<span class="nc" id="L157">        List&lt;ProfileRequestDto.ActivityRequestDto&gt; deleteActivities = activityRequestDtos.stream()</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                .filter(dto -&gt; dto.getCrudType() == CRUDType.DELETE)</span>
<span class="nc" id="L159">                .collect(Collectors.toList());</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!deleteActivities.isEmpty()) {</span>
<span class="nc" id="L162">            List&lt;Long&gt; activityIdsToDelete = deleteActivities.stream()</span>
<span class="nc" id="L163">                    .map(ProfileRequestDto.ActivityRequestDto::getId)</span>
<span class="nc" id="L164">                    .collect(Collectors.toList());</span>

<span class="nc" id="L166">            activityRepository.deleteAllByIdInAndMember(activityIdsToDelete, member);</span>
        }

<span class="nc" id="L169">        List&lt;Activity&gt; activities = activityRequestDtos.stream()</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                .filter(dto -&gt; dto.getCrudType() != CRUDType.DELETE)</span>
<span class="nc" id="L171">                .map(dto -&gt; dto.toEntity(member))</span>
<span class="nc" id="L172">                .collect(Collectors.toList());</span>
<span class="nc" id="L173">        activityRepository.saveAll(activities);</span>

        // Certifications
<span class="nc" id="L176">        List&lt;ProfileRequestDto.CertificationRequestDto&gt; deleteCertifications = certificationRequestDtos.stream()</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                .filter(dto -&gt; dto.getCrudType() == CRUDType.DELETE)</span>
<span class="nc" id="L178">                .collect(Collectors.toList());</span>

<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (!deleteCertifications.isEmpty()) {</span>
<span class="nc" id="L181">            List&lt;Long&gt; certificationIdsToDelete = deleteCertifications.stream()</span>
<span class="nc" id="L182">                    .map(ProfileRequestDto.CertificationRequestDto::getId)</span>
<span class="nc" id="L183">                    .collect(Collectors.toList());</span>

<span class="nc" id="L185">            certificationRepository.deleteAllByIdInAndMember(certificationIdsToDelete, member);</span>
        }

<span class="nc" id="L188">        List&lt;Certification&gt; certifications = certificationRequestDtos.stream()</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                .filter(dto -&gt; dto.getCrudType() != CRUDType.DELETE)</span>
<span class="nc" id="L190">                .map(dto -&gt; dto.toEntity(member))</span>
<span class="nc" id="L191">                .collect(Collectors.toList());</span>
<span class="nc" id="L192">        certificationRepository.saveAll(certifications);</span>


<span class="nc" id="L195">        return ProfileResponseDto.UpdateProfileResponseDto.builder()</span>
<span class="nc" id="L196">                .message(&quot;프로필 수정에 성공했습니다.&quot;)</span>
<span class="nc" id="L197">                .build();</span>
    }

    public void storeUserGeneratedTechStackItem(List&lt;ProfileRequestDto.TechStackRequestDto&gt; techStackRequestDtos, Long memberId){
        //해당 멤버의 이미 있는 techStack들을 조회하여 techStackItem을 저장
<span class="nc" id="L202">        Optional&lt;List&lt;TechStack&gt;&gt; memberTechStacks = techStackRepository.findAllByMemberId(memberId);</span>
<span class="nc" id="L203">        List&lt;TechStackItem&gt; memberTechStackItems = memberTechStacks</span>
<span class="nc" id="L204">                .map(techStacks -&gt; techStacks.stream().</span>
<span class="nc" id="L205">                        map(TechStack::getTechStackItem)</span>
<span class="nc" id="L206">                        .collect(Collectors.toList()))</span>
<span class="nc" id="L207">                .orElse(List.of());</span>

        // techStackRequestDtos에 있는 TechStackItem들 중에서 기존에 없는 것들만 필터링
<span class="nc" id="L210">        List&lt;TechStackItem&gt; newTechStackItems = techStackRequestDtos.stream()</span>
<span class="nc" id="L211">                .map(ProfileRequestDto.TechStackRequestDto::getTechStackItem)</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                .filter(techStackItem -&gt; !memberTechStackItems.contains(techStackItem))</span>
<span class="nc" id="L213">                .collect(Collectors.toList());</span>

<span class="nc" id="L215">        techStackItemRepository.saveAll(newTechStackItems);</span>
<span class="nc" id="L216">    }</span>

    @Override
    @Transactional
    public void deleteProfile(String username){
<span class="nc" id="L221">        Member member = memberRepository.findMemberByUsername(username).orElseThrow(() -&gt; new ApplicationException(ApplicationErrorType.USER_NOT_FOUND));</span>

        try {
<span class="nc" id="L224">            basicProfileRepository.deleteByMember(member);</span>
<span class="nc" id="L225">            techStackRepository.deleteAllByMember(member);</span>
<span class="nc" id="L226">            activityRepository.deleteAllByMember(member);</span>
<span class="nc" id="L227">            certificationRepository.deleteAllByMember(member);</span>
<span class="nc" id="L228">        } catch(Exception e){</span>
<span class="nc" id="L229">            throw new ApplicationException(ApplicationErrorType.PROFILE_ALREADY_EXIST);</span>
<span class="nc" id="L230">        }</span>
<span class="nc" id="L231">    }</span>

    @Override
    @Transactional
    public ProfileResponseDto.CreateEvaluationResponseDto createEvaluation(ProfileRequestDto.CreateEvaluationRequestDto createEvaluationRequestDto, Long givenTeamId, Long subjectMemberId, String username) {
<span class="nc" id="L236">        Member authorMember = memberRepository.findByUsername(username).orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND));</span>
<span class="nc" id="L237">        Member subjectMember = memberRepository.findById(subjectMemberId).orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND));</span>

<span class="nc" id="L239">        Evaluation alreadyExistingEvaluation = evaluationRepository.findByAuthorMemberIdAndSubjectMemberId(authorMember.getId(), subjectMemberId).orElse(null);</span>

        //이미 해당 사용자에 대한 평가 작성 완료함
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (alreadyExistingEvaluation != null) {</span>
<span class="nc" id="L243">            throw new ApplicationException(EVALUATION_ALREADY_EXIST);</span>
        }

        //자가 자신 평가 불가능
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (authorMember.equals(subjectMember)) {</span>
<span class="nc" id="L248">            throw new ApplicationException(UNABLE_TO_EVALUATE_MYSELF);</span>
        }

        //teamId에 해당하는 team 없을 경우
<span class="nc" id="L252">        Team givenTeam = teamRepository.findById(givenTeamId).orElseThrow(() -&gt; new ApplicationException(TEAM_NOT_FOUND));</span>

        //평가자와 피평가자가 주어진 팀에 동시에 속해있지 않을 경우
<span class="nc" id="L255">        MemberTeam memberTeam = memberTeamRepository.findByMemberIdsAndTeamIds(authorMember.getId(), subjectMemberId, givenTeamId);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (memberTeam == null) throw new ApplicationException(USER_NOT_IN_TEAM);</span>

        // 평가 점수 총합은 0~30 이어야 함
<span class="nc" id="L259">        Integer sum = createEvaluationRequestDto.getStat1() + createEvaluationRequestDto.getStat2() + createEvaluationRequestDto.getStat3() + createEvaluationRequestDto.getStat4() + createEvaluationRequestDto.getStat5();</span>
<span class="nc bnc" id="L260" title="All 4 branches missed.">        if (sum &lt; 0 || sum &gt; 30) throw new ApplicationException(EVALUATION_SCORE_NOT_IN_SCOPE);</span>

        //save
<span class="nc" id="L263">        Evaluation evaluation = createEvaluationRequestDto.toEntity(authorMember, subjectMember, givenTeam);</span>
<span class="nc" id="L264">        evaluationRepository.save(evaluation);</span>

<span class="nc" id="L266">        return ProfileResponseDto.CreateEvaluationResponseDto.builder()</span>
<span class="nc" id="L267">                .message(&quot;평가가 완료되었습니다.&quot;)</span>
<span class="nc" id="L268">                .build();</span>
    }

    @Override
    @Transactional
    public ProfileResponseDto.UpdateEvaluationResponseDto updateEvaluation(ProfileRequestDto.UpdateEvaluationRequestDto updateEvaluationRequestDto, Long givenTeamId, Long subjectMemberId, String username) {
<span class="nc" id="L274">        Evaluation evaluationToUpdate = evaluationRepository.findById(updateEvaluationRequestDto.getId()).orElse(null);</span>

        //updateEvaluationDto.getId()를 id로 갖는 평가가 없으면 예외
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (evaluationToUpdate == null) {</span>
<span class="nc" id="L278">            throw new ApplicationException(EVALUATION_NOT_EXIST);</span>
        }

        //해당 평가의 작성자가 본인이 아니면 예외
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (!evaluationToUpdate.getAuthorMember().getUsername().equals(username)) {</span>
<span class="nc" id="L283">            throw new ApplicationException(NOT_AUTHOR_OF_EVALUATION);</span>
        }

<span class="nc" id="L286">        Member authorMember = memberRepository.findByUsername(username).orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND));</span>
<span class="nc" id="L287">        Member subjectMember = memberRepository.findById(subjectMemberId).orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND));</span>

        //자가 자신 평가 불가능
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (authorMember.equals(subjectMember)) {</span>
<span class="nc" id="L291">            throw new ApplicationException(UNABLE_TO_EVALUATE_MYSELF);</span>
        }
        //teamId에 해당하는 team 없을 경우
<span class="nc" id="L294">        Team givenTeam = teamRepository.findById(givenTeamId).orElseThrow(() -&gt; new ApplicationException(TEAM_NOT_FOUND));</span>

        //평가자와 피평가자가 주어진 팀에 동시에 속해있지 않을 경우
<span class="nc" id="L297">        MemberTeam memberTeam = memberTeamRepository.findByMemberIdsAndTeamIds(authorMember.getId(), subjectMemberId, givenTeamId);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (memberTeam == null) throw new ApplicationException(USER_NOT_IN_TEAM);</span>

        // 평가 점수 총합은 0~40 이어야 함
<span class="nc" id="L301">        Integer sum = updateEvaluationRequestDto.getStat1() + updateEvaluationRequestDto.getStat2() + updateEvaluationRequestDto.getStat3() + updateEvaluationRequestDto.getStat4() + updateEvaluationRequestDto.getStat5();</span>
<span class="nc bnc" id="L302" title="All 4 branches missed.">        if (sum &lt; 0 || sum &gt; 40) throw new ApplicationException(EVALUATION_SCORE_NOT_IN_SCOPE);</span>

        //save
<span class="nc" id="L305">        Evaluation evaluation = updateEvaluationRequestDto.toEntity(authorMember, subjectMember, givenTeam);</span>
<span class="nc" id="L306">        evaluationRepository.save(evaluation);</span>

<span class="nc" id="L308">        return ProfileResponseDto.UpdateEvaluationResponseDto.builder()</span>
<span class="nc" id="L309">                .message(&quot;평가가 수정되었습니다.&quot;)</span>
<span class="nc" id="L310">                .build();</span>
    }

    @Override
    @Transactional
    public void deleteEvaluation(ProfileRequestDto.DeleteEvaluationRequestDto deleteEvaluationRequestDto, Long givenTeamId, Long subjectMemberId, String username) {
<span class="nc" id="L316">        Long evaluationId = deleteEvaluationRequestDto.getId();</span>

        //평가 존재 x
<span class="nc" id="L319">        Evaluation evaluationToDelete = evaluationRepository.findById(evaluationId).orElse(null);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (evaluationToDelete == null) {</span>
<span class="nc" id="L321">            throw new ApplicationException(EVALUATION_NOT_EXIST);</span>
        }

<span class="nc" id="L324">        Member authorMember = memberRepository.findByUsername(username).orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND));</span>
<span class="nc" id="L325">        Member subjectMember = memberRepository.findById(subjectMemberId).orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND));</span>

        //자가 자신 평가 불가능
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (authorMember.equals(subjectMember)) {</span>
<span class="nc" id="L329">            throw new ApplicationException(UNABLE_TO_EVALUATE_MYSELF);</span>
        }
        //teamId에 해당하는 team 없을 경우
<span class="nc" id="L332">        Team givenTeam = teamRepository.findById(givenTeamId).orElseThrow(() -&gt; new ApplicationException(TEAM_NOT_FOUND));</span>

        //평가자와 피평가자가 주어진 팀에 동시에 속해있지 않을 경우
<span class="nc" id="L335">        MemberTeam memberTeam = memberTeamRepository.findByMemberIdsAndTeamIds(authorMember.getId(), subjectMemberId, givenTeamId);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (memberTeam == null) throw new ApplicationException(USER_NOT_IN_TEAM);</span>


<span class="nc" id="L339">        evaluationRepository.deleteById(evaluationId);</span>
<span class="nc" id="L340">    }</span>

    @Override
    @Transactional
    public List&lt;ProfileResponseDto.EvaluationResponseDto&gt; getAllEvaluations(String username) {
<span class="nc" id="L345">        Member authorMember = memberRepository.findByUsername(username).orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND));</span>
<span class="nc" id="L346">        List&lt;Evaluation&gt; evaluations = evaluationRepository.findAllByAuthorMemberId(authorMember.getId()).orElseThrow(() -&gt; new ApplicationException(EVALUATION_NOT_EXIST));</span>
<span class="nc" id="L347">        List&lt;ProfileResponseDto.EvaluationResponseDto&gt; evaluationResponseDtos = evaluations.stream().map(Evaluation::toDto).collect(Collectors.toList());</span>
<span class="nc" id="L348">        return evaluationResponseDtos;</span>
    }

    @Override
    @Transactional(readOnly = true)
    public BasicProfile getBasicProfile(String username) {

<span class="nc" id="L355">        return basicProfileRepository.findByMemberId(</span>
<span class="nc" id="L356">                memberRepository.findMemberByUsername(username).orElseThrow(</span>
<span class="nc" id="L357">                        () -&gt; new ApplicationException(ApplicationErrorType.USER_NOT_FOUND)</span>
<span class="nc" id="L358">                ).getId()</span>
<span class="nc" id="L359">        ).orElseThrow(</span>
<span class="nc" id="L360">            () -&gt; new ApplicationException(ApplicationErrorType.NOT_FOUND)</span>
        );
    }

    @Override
    @Transactional
    public ProfileResponseDto.GetTechStackItemsResponseDto getTechStackItems(){
<span class="nc" id="L367">        List&lt;TechStackItem&gt; techStackItems = techStackItemRepository.findByUserGeneratedFalse();</span>

<span class="nc" id="L369">        return ProfileResponseDto.GetTechStackItemsResponseDto.builder()</span>
<span class="nc" id="L370">                .techStackItems(techStackItems)</span>
<span class="nc" id="L371">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>