<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TeamServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TeamPlanner-BE</a> &gt; <a href="index.source.html" class="el_package">com.tbfp.teamplannerbe.domain.team.service.impl</a> &gt; <span class="el_source">TeamServiceImpl.java</span></div><h1>TeamServiceImpl.java</h1><pre class="source lang-java linenums">package com.tbfp.teamplannerbe.domain.team.service.impl;

import com.tbfp.teamplannerbe.domain.common.exception.ApplicationErrorType;
import com.tbfp.teamplannerbe.domain.common.exception.ApplicationException;
import com.tbfp.teamplannerbe.domain.member.entity.Member;
import com.tbfp.teamplannerbe.domain.member.repository.MemberRepository;
import com.tbfp.teamplannerbe.domain.profile.dto.ProfileResponseDto;
import com.tbfp.teamplannerbe.domain.profile.entity.Evaluation;
import com.tbfp.teamplannerbe.domain.profile.repository.EvaluationRepository;
import com.tbfp.teamplannerbe.domain.recruitment.entity.Recruitment;
import com.tbfp.teamplannerbe.domain.recruitment.repository.RecruitmentRepository;
import com.tbfp.teamplannerbe.domain.recruitmentApply.entity.RecruitmentApply;
import com.tbfp.teamplannerbe.domain.recruitmentApply.repository.RecruitmentApplyRepository;
import com.tbfp.teamplannerbe.domain.team.dto.TeamRequestDto;
import com.tbfp.teamplannerbe.domain.team.dto.TeamResponseDto;
import com.tbfp.teamplannerbe.domain.team.dto.TeamResponseDto.createdTeamResponseDto;
import com.tbfp.teamplannerbe.domain.team.entity.MemberTeam;
import com.tbfp.teamplannerbe.domain.team.entity.Team;
import com.tbfp.teamplannerbe.domain.team.repository.MemberTeamRepository;
import com.tbfp.teamplannerbe.domain.team.repository.TeamRepository;
import com.tbfp.teamplannerbe.domain.team.service.TeamService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;


import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import static com.tbfp.teamplannerbe.domain.common.exception.ApplicationErrorType.*;
import static com.tbfp.teamplannerbe.domain.recruitmentApply.entity.RecruitmentApplyStateEnum.ACCEPT;

@Service
<span class="nc" id="L36">@RequiredArgsConstructor</span>
<span class="nc" id="L37">@Slf4j</span>
@Transactional(readOnly = true)
public class TeamServiceImpl implements TeamService {

    private final TeamRepository teamRepository;
    private final RecruitmentRepository recruitmentRepository;
    private final MemberRepository memberRepository;
    private final MemberTeamRepository memberTeamRepository;
    private final RecruitmentApplyRepository recruitmentApplyRepository;
    private final EvaluationRepository evaluationRepository;


    @Transactional
    @Override
    public TeamResponseDto.createdTeamResponseDto createTeam(String username, TeamRequestDto.CreatTeamRequestDto creatTeamRequestDto) {

<span class="nc" id="L53">        System.out.println(creatTeamRequestDto.getSelectedUserIds().size());</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if(creatTeamRequestDto.getSelectedUserIds().size()==0){</span>
<span class="nc" id="L55">            throw new ApplicationException(USER_NOT_FOUND);</span>
        }

<span class="nc" id="L58">        createdTeamResponseDto result = null;</span>

        //selected 한게 참여신청리스트에 해당 팀원모집글에 대해 신청한적이 있는지 확인 신청 한적이없다면 예외처리
        //병렬 스트림의 경우 여러 스레드에서 요소를 처리하므로, 첫 번째 요소를 찾는 것보다 임의의 요소를 찾는 것이 더 효율
<span class="nc" id="L62">        creatTeamRequestDto.getSelectedUserIds().stream()</span>
<span class="nc" id="L63">                .map(selectedUserId -&gt; recruitmentApplyRepository.findRecruitmentApplyByRecruitment_IdAndApplicant_Id(</span>
<span class="nc" id="L64">                        creatTeamRequestDto.getRecruitId(), selectedUserId</span>
<span class="nc" id="L65">                ).orElseThrow(() -&gt; new ApplicationException(RECRUITMENT_APPLY_NOT_APPLIED)))</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                .filter(recruitmentApply -&gt; recruitmentApply.getState() == ACCEPT)</span>
<span class="nc" id="L67">                .findAny()</span>
<span class="nc" id="L68">                .ifPresent(recruitmentApply -&gt; {</span>
<span class="nc" id="L69">                    throw new ApplicationException(ALREADY_TEAM_ACCEPT);</span>
                });


        // 해당하는 모집글이 아직도 존재하는지 확인
<span class="nc" id="L74">        Recruitment recruitment = recruitmentRepository.findById(creatTeamRequestDto.getRecruitId())</span>
<span class="nc" id="L75">                .orElseThrow(() -&gt; new ApplicationException(RECRUITMENT_NOT_FOUND));</span>
<span class="nc" id="L76">        Member leaderMember = memberRepository.findByUsername(username).</span>
<span class="nc" id="L77">                orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND));</span>


        //자기 자신을 팀으로 설정하는경우 예외처리 , 팀의 팀장으로 그대로 남아있게함.
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (creatTeamRequestDto.getSelectedUserIds().contains(leaderMember.getId())) {</span>
<span class="nc" id="L82">            throw new ApplicationException(UNAUTHORIZED);</span>
        }

        // 승인 할 멤버들이 존재하는지 검사
<span class="nc" id="L86">        List&lt;Member&gt; selectedMembers = creatTeamRequestDto.getSelectedUserIds().stream()</span>
<span class="nc" id="L87">                .map(memberId -&gt; memberRepository.findById(memberId)</span>
<span class="nc" id="L88">                        .orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND)))</span>
<span class="nc" id="L89">                .collect(Collectors.toList());</span>

        // 모집글에 대한 팀을 조회
<span class="nc" id="L92">        Team findTeam = teamRepository.findByRecruitmentId(recruitment.getId());</span>


        //기존의 팀이 없음
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (findTeam == null) {</span>
            // max 인원보다 승인하려는 인원이 더 많은 경우
<span class="nc bnc" id="L98" title="All 2 branches missed.">            if (creatTeamRequestDto.getMaxTeamSize() &lt; creatTeamRequestDto.getSelectedUserIds().stream().count() + 1) {</span>
<span class="nc" id="L99">                throw new ApplicationException(TEAM_CAPACITY_EXCEEDED);</span>
            }

            // 팀생성
<span class="nc" id="L103">            Team team = Team.initialCreateTeam(creatTeamRequestDto, recruitment, username);</span>

<span class="nc" id="L105">            team.saveTeamLeaderToTeamMember(leaderMember);</span>
            //팀 저장
<span class="nc" id="L107">            Team savedTeam = teamRepository.save(team);</span>

            //팀 member 저장
<span class="nc" id="L110">            savedTeam.addTeamMembers(selectedMembers, username);</span>


            // 저장된 멤버들을 순회하면서 recruitmentApply 상태값을 ACCEPT값으로 변경
<span class="nc" id="L114">            selectedMembers.forEach(member -&gt; {</span>
<span class="nc" id="L115">                RecruitmentApply recruitmentApply = recruitmentApplyRepository.findRecruitmentApplyByRecruitment_IdAndApplicant_Id(</span>
<span class="nc" id="L116">                        creatTeamRequestDto.getRecruitId(), member.getId()</span>
<span class="nc" id="L117">                ).orElseThrow(() -&gt; new ApplicationException(RECRUITMENT_APPLY_NOT_APPLIED));</span>

<span class="nc" id="L119">                recruitmentApply.updateState(ACCEPT);</span>
<span class="nc" id="L120">            });</span>

            // 변경된 상태값 저장
<span class="nc" id="L123">            Team updatedTeam = teamRepository.save(savedTeam);</span>

            //Response 반환값 변환
<span class="nc" id="L126">            result = createdTeamResponseDto.toDto(updatedTeam);</span>
        }


        //이전에 팀을 생성한 적이 있으면 더티체킹
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (findTeam != null) {</span>

            // 팀 최대인원을 초과하는지 확인
<span class="nc" id="L134">            findTeam.checkTeamCapacity(findTeam, creatTeamRequestDto);</span>

            // 팀 정보를 더티체킹함
<span class="nc" id="L137">            findTeam.updateTeam(creatTeamRequestDto);</span>
            // team 정보 저장
<span class="nc" id="L139">            Team chagedTeam = teamRepository.save(findTeam);</span>


            // team에 members 추가
<span class="nc" id="L143">            chagedTeam.addTeamMembers(selectedMembers, username);</span>

            // 저장된 멤버들을 순회하면서 recruitmentApply 상태값을 ACCEPT값으로 변경
<span class="nc" id="L146">            selectedMembers.forEach(member -&gt; {</span>
<span class="nc" id="L147">                RecruitmentApply recruitmentApply = recruitmentApplyRepository.findRecruitmentApplyByRecruitment_IdAndApplicant_Id(</span>
<span class="nc" id="L148">                        creatTeamRequestDto.getRecruitId(), member.getId()</span>
<span class="nc" id="L149">                ).orElseThrow(() -&gt; new ApplicationException(RECRUITMENT_APPLY_NOT_APPLIED));</span>

<span class="nc" id="L151">                recruitmentApply.updateState(ACCEPT);</span>
<span class="nc" id="L152">            });</span>

            // 변경된 상태값 저장
<span class="nc" id="L155">            Team updatedTeam = teamRepository.save(chagedTeam);</span>

            //Response 반환값 변환
<span class="nc" id="L158">            result = createdTeamResponseDto.toDto(updatedTeam);</span>
        }


<span class="nc" id="L162">        return result;</span>
    }


    @Transactional
    public void deleteTeamMember(String username, Long teamId, Long memberId) {

        //팀장만 팀원삭제가능함
<span class="nc" id="L170">        Team team = teamRepository.findByTeamLeader(username)</span>
<span class="nc" id="L171">                .orElseThrow(() -&gt; new ApplicationException(UNAUTHORIZED));</span>
        //해당하는 팀이 있는지 확인
<span class="nc" id="L173">        teamRepository.findById(teamId).</span>
<span class="nc" id="L174">                orElseThrow(() -&gt; new ApplicationException(TEAM_NOT_FOUND));</span>

        //TeamMember테이블에서 삭제시킴
        //해당하는 테이블에 이게없는데 왜 예외가 안터지냐...?
<span class="nc" id="L178">        memberTeamRepository.deleteByTeamIdAndMemberId(teamId, memberId).</span>
<span class="nc" id="L179">                orElseThrow(() -&gt; new ApplicationException(TEAM_NOT_FOUND));</span>

<span class="nc" id="L181">        team.decreaseTeamSize();</span>
<span class="nc" id="L182">    }</span>

    @Override
    @Transactional
    public void deleteTeam(String username, Long teamId) {

        //팀장만 팀원삭제가능함
<span class="nc" id="L189">        teamRepository.findByTeamLeader(username)</span>
<span class="nc" id="L190">                .orElseThrow(() -&gt; new ApplicationException(UNAUTHORIZED));</span>
        //해당하는 팀이 있는지 확인
<span class="nc" id="L192">        Team team = teamRepository.findById(teamId).</span>
<span class="nc" id="L193">                orElseThrow(() -&gt; new ApplicationException(TEAM_NOT_FOUND));</span>
        //멤버팀테이블에 teamId인거 싹다 지워야야하고
<span class="nc" id="L195">        List&lt;MemberTeam&gt; memberTeamList = memberTeamRepository.findAllByTeamId(teamId);</span>

        //순회하면서 member하나씩 삭제
<span class="nc" id="L198">        memberTeamList.stream().forEach(</span>
<span class="nc" id="L199">                memberTeam -&gt; memberTeamRepository.deleteByMemberId(memberTeam.getId())</span>
<span class="nc" id="L200">                        .orElseThrow(() -&gt; new ApplicationException(USER_NOT_FOUND))</span>
        );
        //memberTeam 다 삭제 됐으면 해당 팀 삭제
<span class="nc" id="L203">        teamRepository.deleteById(teamId);</span>
<span class="nc" id="L204">    }</span>

    @Override
    public List&lt;TeamResponseDto.GetMyTeamResponseDto&gt; getMyTeam(String username){
<span class="nc" id="L208">        Optional&lt;Member&gt; member = memberRepository.findByUsername(username);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if(!member.isPresent()){</span>
<span class="nc" id="L210">            throw new ApplicationException(USER_NOT_FOUND);</span>
        }
<span class="nc" id="L212">        Long memberId = member.get().getId();</span>

        //fetchJoin된 쿼리로 N+1 문제 해결
<span class="nc" id="L215">        List&lt;Team&gt; teams = teamRepository.findAllTeamsByMemberId(memberId);</span>

<span class="nc" id="L217">        List&lt;TeamResponseDto.GetMyTeamResponseDto&gt; getMyTeamResponseDtos = teams.stream()</span>
<span class="nc" id="L218">                .map(team -&gt; TeamResponseDto.GetMyTeamResponseDto.toDto(team))</span>
<span class="nc" id="L219">                .collect(Collectors.toList());</span>

<span class="nc" id="L221">        return getMyTeamResponseDtos;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>